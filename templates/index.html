<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Swing Camera</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        /* Page-specific styles for index.html */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="flex-1">
                <h1>üìπ Impact Camera</h1>
                <p class="subtitle">Capture fast motion in high-speed detail</p>
            </div>
            <div class="nav-buttons">
                <span class="nav-button nav-button-current">üè† Home</span>
                <a href="/preview" class="nav-button">üëÅÔ∏è Preview</a>
                <a href="/settings" class="nav-button">‚öôÔ∏è Settings</a>
            </div>
        </div>
        
        <div id="message"></div>
        
        <div class="status">
            <h3>Camera Status</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Resolution</div>
                    <div class="status-value" id="resolution">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Frame Rate</div>
                    <div class="status-value" id="fps">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Duration</div>
                    <div class="status-value" id="duration">-</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Shutter</div>
                    <div class="status-value" id="shutter">-</div>
                </div>
            </div>
        </div>

        <div id="videoPlayer" class="video-player">
            <video id="replayVideo" loop muted playsinline autoplay></video>
            <div class="video-controls">
                <div class="speed-control">
                    <span class="text-label">Playback Speed:</span>
                    <button class="speed-button active" onclick="setPlaybackSpeed(0.0625, this)" aria-label="Play at 16x slow motion">0.0625x</button>
                    <button class="speed-button" onclick="setPlaybackSpeed(0.125, this)" aria-label="Play at 8x slow motion">0.125x</button>
                    <button class="speed-button" onclick="setPlaybackSpeed(0.25, this)" aria-label="Play at 4x slow motion">0.25x</button>
                    <button class="speed-button" onclick="setPlaybackSpeed(0.5, this)" aria-label="Play at 2x slow motion">0.5x</button>
                </div>
                <div class="text-meta" id="videoInfo">-</div>
            </div>
        </div>

        <button id="recordButton" class="record-button">üé• Record Swing</button>
        
        <div class="recordings">
            <div class="flex-between-mb">
                <h2 class="mb-0">Recent Recordings</h2>
                <button id="deleteAllButton" class="delete-button hidden" onclick="deleteAllRecordings()">
                    üóëÔ∏è Delete All Recordings
                </button>
            </div>
            <div id="recordingList" class="recording-list">
                <div class="empty-state">No recordings yet. Press the button above to capture your first swing!</div>
            </div>
        </div>
    </div>
    
    <script>
        let isRecording = false;
        let statusInterval;
        let currentPlaybackSpeed = 0.5;
        let lastRecordingCount = 0;

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                document.getElementById('resolution').textContent = data.config.resolution;
                document.getElementById('fps').textContent = data.config.fps + ' fps';
                document.getElementById('duration').textContent = data.config.duration + 's';
                document.getElementById('shutter').textContent = '1/' + Math.round(1000000 / data.config.shutter_speed) + 's';

                isRecording = data.recording;
                updateRecordButton();
            } catch (error) {
                console.error('Failed to update status:', error);
            }
        }

        async function loadRecordings() {
            try {
                const response = await fetch('/api/recordings');
                const data = await response.json();

                const listElement = document.getElementById('recordingList');

                if (data.recordings.length === 0) {
                    listElement.innerHTML = '<div class="empty-state">No recordings yet. Press the button above to capture your first swing!</div>';
                    document.getElementById('deleteAllButton').classList.add('hidden');
                    lastRecordingCount = 0;
                    return;
                }

                const deleteAllButton = document.getElementById('deleteAllButton');
                deleteAllButton.classList.remove('hidden');

                // Check if a new recording was added (e.g., from launch monitor integration)
                const newRecordingAdded = data.recordings.length > lastRecordingCount;
                lastRecordingCount = data.recordings.length;

                listElement.innerHTML = data.recordings.reverse().map(rec => {
                    const sizeMB = (rec.size / 1024 / 1024).toFixed(2);
                    const date = new Date(rec.created * 1000).toLocaleString();

                    return `
                        <div class="recording-item">
                            <div class="recording-info">
                                <div class="recording-name">${rec.name}</div>
                                <div class="recording-meta">${sizeMB} MB ¬∑ ${date}</div>
                            </div>
                            <div class="flex-row">
                                <button class="download-button" onclick="downloadRecording('${rec.name}')">
                                    ‚¨áÔ∏è Download
                                </button>
                                <button class="delete-button" onclick="deleteRecording('${rec.name}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Auto-play new recordings (from manual or launch monitor integration)
                if (newRecordingAdded) {
                    playLatestRecording();
                }
            } catch (error) {
                console.error('Failed to load recordings:', error);
            }
        }
        
        function updateRecordButton() {
            const button = document.getElementById('recordButton');
            
            if (isRecording) {
                button.textContent = 'üî¥ Recording...';
                button.classList.add('recording');
                button.disabled = true;
            } else {
                button.textContent = 'üé• Record Swing';
                button.classList.remove('recording');
                button.disabled = false;
            }
        }
        
        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            
            setTimeout(() => {
                messageDiv.className = '';
                messageDiv.textContent = '';
            }, 5000);
        }
        
        async function startRecording() {
            try {
                const response = await fetch('/api/record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage(`Recording started! Will capture for ${data.duration} seconds...`);

                    setTimeout(() => {
                        loadRecordings();
                        showMessage('Recording complete! ‚úì');
                        playLatestRecording();
                    }, data.duration * 1000 + 1000);
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Failed to start recording', 'error');
                console.error('Recording error:', error);
            }
        }
        
        function downloadRecording(filename) {
            window.location.href = `/api/download/${filename}`;
        }
        
        async function deleteRecording(filename) {
            if (!confirm(`Delete ${filename}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/recordings/${filename}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage(`Deleted ${filename}`);
                    loadRecordings();
                } else {
                    showMessage(data.message || 'Failed to delete recording', 'error');
                }
            } catch (error) {
                console.error('Failed to delete recording:', error);
                showMessage('Failed to delete recording', 'error');
            }
        }
        
        async function deleteAllRecordings() {
            if (!confirm('Delete ALL recordings? This cannot be undone!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/recordings', {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showMessage(`Deleted ${data.count} recording(s)`);
                    loadRecordings();
                } else {
                    showMessage(data.message || 'Failed to delete recordings', 'error');
                }
            } catch (error) {
                console.error('Failed to delete all recordings:', error);
                showMessage('Failed to delete recordings', 'error');
            }
        }
        
        async function playLatestRecording() {
            try {
                const response = await fetch('/api/recordings');
                const data = await response.json();

                if (data.recordings.length === 0) {
                    return;
                }

                const latest = data.recordings[data.recordings.length - 1];
                const videoPlayer = document.getElementById('videoPlayer');
                const video = document.getElementById('replayVideo');
                const videoInfo = document.getElementById('videoInfo');

                video.src = `/api/download/${latest.name}`;

                // Set intelligent default playback speed based on capture FPS
                // Higher FPS = slower default playback for impact analysis
                const fps = latest.metadata?.fps || 30;
                let defaultSpeed = 1.0;

                if (fps >= 200) {
                    defaultSpeed = 0.0625;  // 16x slow motion for 240fps (15fps playback)
                } else if (fps >= 120) {
                    defaultSpeed = 0.25;  // 4x slow motion for 120fps (30fps playback)
                } else if (fps >= 60) {
                    defaultSpeed = 0.5;   // 2x slow motion for 60fps
                } else {
                    defaultSpeed = 1.0;   // Real-time for 30fps
                }

                currentPlaybackSpeed = defaultSpeed;

                // Update button states
                document.querySelectorAll('.speed-button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent === `${defaultSpeed}x`) {
                        btn.classList.add('active');
                    }
                });

                const sizeMB = (latest.size / 1024 / 1024).toFixed(2);
                videoInfo.textContent = `${latest.name} (${sizeMB} MB) - ${fps}fps - ${defaultSpeed}x default`;

                videoPlayer.style.display = 'block';

                // Set playback rate after video loads to ensure it sticks
                video.addEventListener('loadedmetadata', function setRate() {
                    video.playbackRate = defaultSpeed;
                    console.log(`Set playback rate to ${defaultSpeed}x for ${fps}fps video`);
                    video.removeEventListener('loadedmetadata', setRate);
                }, { once: true });

                video.play().catch(err => {
                    console.error('Autoplay failed:', err);
                    showMessage('Click the video to play', 'error');
                });
            } catch (error) {
                console.error('Failed to play latest recording:', error);
            }
        }

        function setPlaybackSpeed(speed, button) {
            console.log('setPlaybackSpeed called with speed:', speed, 'button:', button);
            currentPlaybackSpeed = speed;
            const video = document.getElementById('replayVideo');
            video.playbackRate = speed;
            console.log('Video playback rate set to:', video.playbackRate);

            document.querySelectorAll('.speed-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (button) {
                button.classList.add('active');
                console.log('Button activated:', button.textContent);
            }
        }

        document.getElementById('recordButton').addEventListener('click', startRecording);

        updateStatus();
        loadRecordings();
        playLatestRecording();

        statusInterval = setInterval(updateStatus, 1000);
        setInterval(loadRecordings, 5000);
    </script>
</body>
</html>

