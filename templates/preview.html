<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Preview - High-Speed Camera</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        /* Page-specific styles for preview.html */
        .container {
            max-width: 1200px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üëÅÔ∏è Live Preview</h1>
            <div class="nav-buttons">
                <a href="/" class="nav-button">üè† Home</a>
                <span class="nav-button nav-button-current">üëÅÔ∏è Preview</span>
                <a href="/settings" class="nav-button">‚öôÔ∏è Settings</a>
            </div>
        </div>

        <div class="content">
            <div class="video-container">
                <img id="video-feed" src="/video_feed" alt="Live camera feed">
            </div>

            <div class="controls-panel">
                <h2>Camera Controls</h2>
                <div class="status-indicator">LIVE</div>

                <div class="control-group">
                    <label>Recording Mode</label>
                    <div id="presetContainer" class="grid-2col mt-10">
                        <!-- Presets loaded dynamically from API -->
                        <div style="text-align: center; padding: 20px; color: #666; grid-column: 1 / -1;">
                            Loading camera modes...
                        </div>
                    </div>
                    <div class="help-text">Click a mode to reconfigure camera</div>
                </div>

                <div class="info-box warning">
                    <strong>Note:</strong>
                    <p>
                        These settings update the live preview only. Use the Settings page to save permanent changes.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SINGLE SOURCE OF TRUTH: Presets loaded from recording_presets.json via API
        let presets = {};

        // Icon mapping for categories
        const categoryIcons = {
            'Standard': 'üé•',
            'Slow Motion': 'üé¨',
            'High Speed': '‚ö°'
        };

        async function loadPresets() {
            try {
                const response = await fetch('/api/preset');
                const data = await response.json();

                if (data.status === 'success') {
                    presets = data.presets;
                    renderPresets();
                } else {
                    console.error('Failed to load presets:', data.message);
                }
            } catch (error) {
                console.error('Failed to load presets:', error);
                document.getElementById('presetContainer').innerHTML =
                    '<div style="text-align: center; padding: 20px; color: #d32f2f; grid-column: 1 / -1;">Failed to load camera modes</div>';
            }
        }

        function renderPresets() {
            const container = document.getElementById('presetContainer');

            // Build HTML for all presets
            let html = '';
            for (const [presetId, preset] of Object.entries(presets)) {
                const icon = categoryIcons[preset.category] || 'üìπ';
                const shutterDisplay = preset.shutter_speed ?
                    `1/${Math.round(1000000 / preset.shutter_speed)}s` : 'Auto';

                html += `
                    <div class="mode-card" data-mode="${presetId}" onclick="selectMode('${presetId}')">
                        <div class="mode-icon">${icon}</div>
                        <div class="mode-name">${preset.name}</div>
                        <div class="mode-specs">${preset.width}x${preset.height} @ ${preset.fps}fps ¬∑ ${shutterDisplay}</div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Select mode and reconfigure camera
        async function selectMode(presetName) {
            const preset = presets[presetName];
            if (!preset) return;

            // Mark as active
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('active'));
            document.querySelector(`[data-mode="${presetName}"]`).classList.add('active');

            try {
                // Apply preset via proper endpoint
                const response = await fetch('/api/preset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ preset: presetName })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    console.log(`Switched to ${presetName} preset - camera reconfigured`);
                    // Camera is already reconfigured by the time we get here (synchronous backend)
                    // Video stream will automatically show new resolution - no reload needed!
                } else {
                    alert(`Failed to switch mode: ${data.message}`);
                }
            } catch (error) {
                console.error('Mode switch failed:', error);
                alert(`Error switching mode: ${error}`);
            }
        }

        // Detect current mode on load
        async function detectCurrentMode() {
            try {
                const resp = await fetch('/api/config');
                const data = await resp.json();
                const config = data.config;

                // Find matching preset
                for (const [presetId, presetConfig] of Object.entries(presets)) {
                    if (config.width === presetConfig.width &&
                        config.height === presetConfig.height &&
                        config.fps === presetConfig.fps) {
                        document.querySelector(`[data-mode="${presetId}"]`)?.classList.add('active');
                        break;
                    }
                }
            } catch (error) {
                console.error('Failed to detect current mode:', error);
            }
        }

        // Initialize page
        async function initializePage() {
            await loadPresets();
            await detectCurrentMode();
        }

        initializePage();
    </script>
</body>
</html>
